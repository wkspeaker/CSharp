# 公会时间计算器项目文档

## 项目概述

本项目是一个基于WPF和MVVM架构的公会时间计算器应用程序，主要用于管理公会成员的时间安排和消息生成。项目采用C#开发，使用WPF作为UI框架，实现了完整的数据持久化和模板系统。

## 技术架构

### 架构模式
- **MVVM模式**：Model-View-ViewModel分离
- **数据绑定**：双向数据绑定实现界面与模型同步
- **依赖注入**：服务层解耦
- **数据持久化**：JSON文件存储

### 项目结构
```
TimeCalculatorForGuild/
├── Models/                 # 数据模型层
│   └── TimeCalculator.cs
├── ViewModels/            # 视图模型层
│   └── MainWindowViewModel.cs
├── Views/                 # 视图层
│   └── MainWindow.xaml
├── Services/              # 服务层
│   └── DataService.cs
├── Helpers/               # 辅助类
│   └── TimeFormatConverter.cs
├── Data/                  # 数据存储
│   └── GuildInfo.json
└── MainWindow.xaml.cs     # 代码后置
```

## 核心功能需求

### 1. 时间计算功能
- **时间间隔输入**：支持小数格式(14.32)和时分格式(14:32)
- **时间计算**：当前时间 + TimeGap = 调整时间
- **时间取整**：半小时向后取整(05:40→6点，19:19→19点半)
- **周几显示**：中文周几名称(周一、周二等)

### 2. 模板系统
- **变量替换**：{变量名}语法
- **多格式支持**：支持多种时间格式变量
- **自定义模板**：用户可编辑消息模板
- **实时生成**：模板变量实时替换

### 3. 团类型管理
- **切换功能**：主团/副团一键切换
- **状态持久化**：团类型状态自动保存
- **模板集成**：团类型变量支持

### 4. 数据持久化
- **自动保存**：应用退出时自动保存
- **自动加载**：应用启动时自动加载
- **JSON存储**：结构化数据存储

## 类成员设计

### TimeCalculator类 (Models/TimeCalculator.cs)

#### 属性成员
```csharp
public string OutputMessage { get; set; } = string.Empty;           // 输出消息
public string OutputMessageTemplate { get; set; } = string.Empty;    // 消息模板
public string MainGuild { get; set; } = string.Empty;              // 主公会
public string SecondaryGuild { get; set; } = string.Empty;        // 副公会
public decimal TimeGap { get; set; }                                // 时间间隔(小时)
public string ComingWeek { get; set; } = string.Empty;             // 下周范围
public int GuildType { get; set; } = 0;                             // 团类型(0=主团,1=副团)
```

#### 方法成员
```csharp
// 时间计算方法
public DateTime CalculateTime()                                     // 计算调整时间
public string CalculateAdjustedTime()                               // 格式化调整时间
public string CalculateComingWeek()                                // 计算下周范围

// 团类型管理
public string GetGuildTypeName()                                    // 获取团类型名称
public void ToggleGuildType()                                       // 切换团类型

// 模板处理
public void GenerateMsg()                                           // 生成消息
private string ProcessTemplate(string template, DateTime calculatedTime)  // 处理模板
private string GetWeekdayName(DayOfWeek dayOfWeek)                  // 获取周几名称
private string RoundToHalfHour(DateTime dateTime)                  // 时间取整
```

### MainWindowViewModel类 (ViewModels/MainWindowViewModel.cs)

#### 属性成员
```csharp
public TimeCalculator TimeCalculator { get; set; }                 // 时间计算器实例
public string OutputMessage { get; set; }                          // 输出消息
public string OutputMessageTemplate { get; set; }                  // 消息模板
public string MainGuild { get; set; }                              // 主公会
public string SecondaryGuild { get; set; }                         // 副公会
public decimal TimeGap { get; set; }                               // 时间间隔
public string TimeGapString { get; set; }                           // 时间间隔字符串
public string ComingWeek { get; set; }                              // 下周范围
public string GuildTypeName { get; }                                // 团类型名称
```

#### 方法成员
```csharp
public void GenerateMsg()                                          // 生成消息
public void SaveData()                                              // 保存数据
public void LoadData()                                              // 加载数据
public void ToggleGuildType()                                       // 切换团类型
private decimal ParseTimeFormat(string timeString)                 // 解析时间格式
```

### DataService类 (Services/DataService.cs)

#### 方法成员
```csharp
public TimeCalculator LoadData()                                   // 加载数据
public bool SaveData(TimeCalculator timeCalculator)               // 保存数据
public bool DataFileExists()                                       // 检查文件存在
public string GetDataFilePath()                                    // 获取文件路径
```

### TimeFormatConverter类 (Helpers/TimeFormatConverter.cs)

#### 方法成员
```csharp
public object Convert(object value, Type targetType, object parameter, CultureInfo culture)      // 转换为界面值
public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)  // 转换为模型值
private decimal ParseTimeFormat(string timeString)                 // 解析时分格式
```

## 实现机制

### 1. 数据绑定机制

#### 双向绑定
```xml
<TextBox Text="{Binding TimeGapString, UpdateSourceTrigger=PropertyChanged}" />
```

#### 单向绑定
```xml
<TextBox Text="{Binding MainGuild, Mode=OneWay}" IsReadOnly="True" />
```

#### 命令绑定
```xml
<Button Click="GenerateMsgButton_Click" />
```

### 2. 时间格式处理机制

#### 输入格式支持
- **小数格式**：`14.32` → 14小时32分钟
- **时分格式**：`14:32` → 14小时32分钟
- **自动转换**：`14:32` → 14.53小时

#### 时间取整逻辑
```csharp
// 分钟数 > 30：小时+1，分钟=0
// 分钟数 1-30：分钟=30
// 分钟数 = 0：保持不变
```

### 3. 模板变量系统

#### 支持的变量
| 变量名 | 描述 | 示例输出 |
|--------|------|----------|
| `{MainGuild}` | 主公会名称 | "工会A" |
| `{SecondaryGuild}` | 副公会名称 | "工会B" |
| `{TimeGap}` | 时间间隔 | "14.53" |
| `{ComingWeek}` | 下周范围 | "10.27 ~ 11.02" |
| `{GuildOfComingWeek}` | 团类型 | "主团" |
| `{AdjustedTime}` | 调整时间 | "周日(10.26)6点" |
| `{CalculatedTime}` | 计算时间 | "2025-10-26 05:40:47" |
| `{CurrentTime}` | 当前时间 | "2025-10-25 15:08:47" |

#### 模板处理流程
1. 获取模板字符串
2. 计算所有变量值
3. 替换模板中的变量
4. 返回处理后的消息

### 4. 数据持久化机制

#### JSON文件结构
```json
{
  "OutputMessage": "",
  "OutputMessageTemplate": "当前的主公会为{MainGuild}，副工会为{SecondaryGuild}。调整时间：{AdjustedTime}，下周范围：{ComingWeek}，团类型：{GuildOfComingWeek}",
  "MainGuild": "",
  "SecondaryGuild": "",
  "TimeGap": 0.0,
  "ComingWeek": "",
  "GuildType": 0
}
```

#### 自动保存机制
- **应用启动**：自动加载JSON数据
- **数据变更**：实时同步到模型
- **应用退出**：自动保存到JSON文件

### 5. 界面交互机制

#### 切换按钮实现
```csharp
public void ToggleGuildType()
{
    _timeCalculator.ToggleGuildType();
    OnPropertyChanged(nameof(GuildTypeName));
}
```

#### 事件处理
```csharp
private void ToggleGuildTypeButton_Click(object sender, RoutedEventArgs e)
{
    if (DataContext is MainWindowViewModel viewModel)
    {
        viewModel.ToggleGuildType();
    }
}
```

## 业务逻辑

### 1. 时间计算逻辑

#### 基本计算
```
当前时间 + TimeGap = 调整时间
示例：2025.10.25 15:08:47 + 14:32 = 2025.10.26 05:40:47
```

#### 时间取整规则
```
05:40 → 6点 (分钟>30，小时+1)
19:19 → 19点半 (分钟1-30，设为30)
14:00 → 14点 (分钟=0，保持不变)
```

#### 周几计算
```
2025.10.25 → 周六
2025.10.26 → 周日
```

### 2. 下周范围计算

#### 计算逻辑
```
当前日期 → 下一周周一 → 下一周周日
示例：2025.10.25(周六) → 2025.10.27(周一) ~ 2025.11.02(周日)
```

#### 输出格式
```
MM.dd ~ MM.dd
示例：10.27 ~ 11.02
```

### 3. 团类型切换逻辑

#### 切换规则
```
0 (主团) ↔ 1 (副团)
```

#### 显示规则
```
0 → "主团"
1 → "副团"
```

### 4. 模板生成逻辑

#### 生成流程
1. 计算调整时间
2. 计算下周范围
3. 获取团类型名称
4. 替换模板变量
5. 生成最终消息

#### 默认模板
```
当前的主公会为{MainGuild}，副工会为{SecondaryGuild}。调整时间：{AdjustedTime}，下周范围：{ComingWeek}，团类型：{GuildOfComingWeek}
```

## 界面设计

### 界面布局
```
┌─────────────────────────────────────┐
│ 显示消息: [多行文本框]              │
│ 消息模板: [多行文本框]              │
│ 主工会: [只读文本框]                │
│ 副工会: [只读文本框]                │
│ 下次加入公会冷却时间: [输入框]       │
│ 下周范围: [输入框]                  │
│ 当前团类型: [切换按钮]               │
│           [生成消息]                │
└─────────────────────────────────────┘
```

### 控件特性
- **显示消息**：支持多行，自动换行
- **消息模板**：支持多行，变量提示
- **时间输入**：支持小数和时分格式
- **切换按钮**：一键切换团类型
- **生成按钮**：居中显示，主要操作

## 数据流

### 1. 数据加载流程
```
应用启动 → DataService.LoadData() → TimeCalculator → ViewModel → 界面显示
```

### 2. 数据保存流程
```
界面输入 → ViewModel → TimeCalculator → DataService.SaveData() → JSON文件
```

### 3. 消息生成流程
```
点击生成 → GenerateMsg() → 计算时间 → 处理模板 → 更新界面
```

## 扩展性设计

### 1. 模板变量扩展
- 可轻松添加新的模板变量
- 支持格式化输出
- 支持条件显示

### 2. 时间格式扩展
- 支持更多时间格式
- 支持时区处理
- 支持自定义取整规则

### 3. 团类型扩展
- 可扩展更多团类型
- 支持自定义团类型名称
- 支持团类型配置

## 技术特点

### 1. 用户体验
- **直观操作**：一键切换，实时反馈
- **格式灵活**：支持多种时间输入格式
- **模板自定义**：用户可自定义消息模板
- **数据持久化**：自动保存，无需手动操作

### 2. 技术优势
- **MVVM架构**：清晰的代码结构
- **数据绑定**：界面与模型自动同步
- **异常处理**：完善的错误处理机制
- **扩展性强**：易于添加新功能

### 3. 性能优化
- **懒加载**：按需加载数据
- **内存管理**：合理的数据生命周期
- **响应式**：实时界面更新

## 总结

本项目成功实现了一个功能完整的公会时间计算器，具有以下特点：

1. **功能完整**：时间计算、模板系统、团类型管理、数据持久化
2. **用户友好**：直观的界面设计，灵活的时间输入
3. **技术先进**：MVVM架构，数据绑定，异常处理
4. **扩展性强**：模块化设计，易于维护和扩展

项目代码结构清晰，功能实现完整，用户体验良好，是一个成功的WPF应用程序示例。



